#
# test_opt v3.0 -*- Perl -*-
#
# Testing harness for the opt_depot scripts
#
#************************************************************************
#
# Copyright (C) 1993-2003  The University of Texas at Austin.
#
#    This program is free software; you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation; either version 2 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program; if not, write to the Free Software
#    Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
#    02111-1307, USA
#
#    Written by: Computer Science Division, Applied Research Laboratories,
#    University of Texas at Austin  opt-depot@arlut.utexas.edu
#
#***********************************************************************
# Written by Jonathan Abbey
# 10 September 2003
#
# Release: $Name:  $
# Version: $Revision: 1.5 $
# Last Mod Date: $Date: 2003/09/12 02:47:18 $
#
#####################################################################

use English;
use FindBin qw($RealBin $RealScript);

use lib "$RealBin/../modules";
use Opt_depot::Common;

$version = "3.0";

## defaults #########################################################

$test_dir = "/tmp/opt_suite/base";
$test_logdir = "/tmp/opt_suite/log";
$test_etc = "/tmp/opt_suite/etc";

#####################################################################

$testconfA =<< "ENDTESTCONF1";
Base: $test_dir
Depot: $test_dir/depot
Log: $test_logdir/opt_depot.log
SiteFile: $test_etc/sites
Subdirs: bin,include,info,lib,man
AlwaysRecurse: No
Recurse: include,lib,info
ENDTESTCONF1

$testsitesA =<< "ENDSITES1";
ENDSITES1

%test0 = (label  => 'Simple single-package link test',
	  root   => $test_dir,
	  start  => ['depot/packA/bin/hi',
		     'depot/packA/lib/perl5/spam/x.pl',
		     'depot/packA/include/test.h',
		     'depot/packA/man/manl/test.l'],
	  end    => ['bin/', 'lib/', 'man/', 'include/', 'man/manl/',
		     'bin/hi->depot/packA/bin/hi',
		     'lib/perl5->depot/packA/lib/perl5/',
		     'include/test.h->depot/packA/include/test.h',
		     'man/manl/test.l->depot/packA/man/manl/test.l'],
	  endex  => ['depot/'],
	  conf   => $testconfA,
	  sites  => $testsitesA,
	  action => 'opt_depot');

%test1 = (label  => 'Elementary recursion test',
	  root   => $test_dir,
	  start  => ['depot/packA/bin/hi',
		     'depot/packA/lib/perl5/spam/x.pl',
		     'depot/packA/include/test.h',
		     'depot/packB/bin/hi',
		     'depot/packB/lib/perl5/spam/y.pl',
		     'depot/packB/include/test.h'],
	  end    => ['bin/', 'lib/', 'man/', 'include/',
		     'bin/hi->depot/packA/bin/hi',
		     'lib/perl5/spam/x.pl->depot/packA/lib/perl5/spam/x.pl',
		     'lib/perl5/spam/y.pl->depot/packB/lib/perl5/spam/y.pl',
		     'include/test.h->depot/packB/include/test.h'],
	  endex  => ['depot/'],
	  conf   => $testconfA,
	  sites  => $testsitesA,
	  action => 'opt_depot');

@tests = (\%test0, \%test1);

#####################################################################

#########################################################################
#
#                                                              setup_test
#
# input: a reference to one of our test descriptions
#
# setup_test does everything required to create a test environment for
# a given test, including creating a fresh directory structure.
#
#########################################################################

sub setup_test {
  my ($href) = @_;

  my ($label, $rootdir, $startary, $label, $element, $newpath);

  $label = $href->{'label'};
  $rootdir = $href->{'root'};
  $startary = $href->{'start'};

  print "Setting up \"$label\" at $rootdir\n";

  killdir($rootdir);
  
  foreach $element (@$startary) {

    if ($rootdir =~ /\/$/) {
      $newpath = $rootdir . $element;
    } else {
      $newpath = $rootdir . "/" . $element;
    }

    if ($newpath =~ /\/$/) {
      if (!create_dir($newpath)) {
	return 0;
      }
    } else {
      if (!create_dir(extractdir($newpath))) {
	return 0;
      }

      touch($newpath);
    }
  }

  killdir($test_etc);
  create_dir($test_etc);

  if (!open(OUT, ">$test_etc/opt.config")) {
    print "Couldn't open $test_etc/opt.config";
    return 0;
  }
  print OUT $href->{'conf'};
  close(OUT);

  if (!open(OUT, ">$test_etc/sites")) {
    print "Couldn't open $test_etc/sites";
    return 0;
  }
  print OUT $href->{'sites'};
  close(OUT);

  killdir($test_logdir);
  create_dir($test_logdir);
  
  return 1;
}

#########################################################################
#
#                                                                run_test
#
# input: a reference to one of our test descriptions
#
# run_test runs the test
#
#########################################################################

sub run_test {
  my ($href) = @_;
}

#####################################################################
#
# mkdir $test_dir
# mkdir $test_dir/depot
#
# touch a bunch of stuff
# run opt_depot
# test
#####################################################################

#create_dir($test_dir);
#create_dir($test_logdir);
#create_dir($test_etc);

print "$0\n";
print "$RealScript\n";
setup_test(\%test1);
